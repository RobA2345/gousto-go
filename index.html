<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gousto Archive</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div id="view-toggle" class="header-icon">üìã</div>
<div id="search-icon" class="header-icon">üîç</div>
<a href="https://www.buymeacoffee.com/robertlindley" target="_blank" id="bmc-icon" class="header-icon">‚òï</a>

<div id="search-overlay">
    <input type="text" id="search-input" placeholder="Search ingredients or titles..." autofocus>
</div>

<div id="shopping-list-overlay">
    <div class="shopping-list-modal">
        <div class="modal-close" onclick="closeShoppingList()">&times;</div>
        <h2>Shopping List</h2>
        <div id="shopping-list-items" class="shopping-list-items"></div>
        <button id="make-list-btn">Share / Copy List</button>
    </div>
</div>

<div id="fullscreen-viewer">
    <div class="close-btn">&times;</div>

    <div id="fs-card" class="fullscreen-card">
        <div class="card-face front">
            <img id="fs-img-front" src="" alt="Ingredients">
        </div>
        <div class="card-face back">
            <img id="fs-img-back" src="" alt="Method">
        </div>
    </div>
    <button id="shop-btn">Shop Ingredients</button>
</div>

<div id="recipe-grid" class="grid"></div>

<script>
    let allRecipes = [];
    let isListView = false;
    let currentRecipe = null;

    async function init() {
        const resp = await fetch('data.json');
        const data = await resp.json();
        allRecipes = data.recipes;
        render(allRecipes);
    }

    function render(list) {
        const grid = document.getElementById('recipe-grid');
        grid.innerHTML = list.map(r => `
                <div class="recipe-card" data-id="${r.id}">
                    <div class="card-inner">
                        <div class="card-front">
                            <img src="${r.image_front}" alt="Front">
                            <div class="nutrition-bar">
                                <span>üî• ${r.nutrition.calories}</span>
                                <span>üí™ ${r.nutrition.protein}</span>
                                <span>üçû ${r.nutrition.carbs}</span>
                            </div>
                        </div>
                        <div class="card-back">
                            <img src="${r.image_back}" alt="Back">
                        </div>
                        <div class="recipe-title">${r.title}</div>
                    </div>
                </div>
            `).join('');
    }

    function toggleView() {
        isListView = !isListView;
        const grid = document.getElementById('recipe-grid');
        const toggleBtn = document.getElementById('view-toggle');

        if (isListView) {
            grid.classList.add('list-view');
            toggleBtn.textContent = '‚ñ¶'; // Switch icon to grid
        } else {
            grid.classList.remove('list-view');
            toggleBtn.textContent = 'üìã'; // Switch icon to list
        }
    }

    function openFullscreen(recipeId) {
        currentRecipe = allRecipes.find(r => r.id === recipeId);
        if (!currentRecipe) return;

        const viewer = document.getElementById('fullscreen-viewer');
        const card = document.getElementById('fs-card');

        // Reset flip state so it always opens on the front
        card.classList.remove('is-flipped');

        document.getElementById('fs-img-front').src = currentRecipe.image_front;
        document.getElementById('fs-img-back').src = currentRecipe.image_back;

        viewer.classList.add('open');
        document.body.classList.add('no-scroll');
    }

    function toggleFlip(event) {
        // Prevent the close button or background clicks from triggering this
        event.stopPropagation();
        const card = document.getElementById('fs-card');
        card.classList.toggle('is-flipped');
    }

    function closeFullscreen() {
        document.getElementById('fullscreen-viewer').classList.remove('open');
        document.body.classList.remove('no-scroll');
        currentRecipe = null;
    }

    function openSearch() {
        const overlay = document.getElementById('search-overlay');
        const input = document.getElementById('search-input');
        overlay.classList.add('open');
        input.focus();
    }

    function closeSearch() {
        document.getElementById('search-overlay').classList.remove('open');
    }

    function openShoppingList() {
        if (!currentRecipe) return;

        const overlay = document.getElementById('shopping-list-overlay');
        const listContainer = document.getElementById('shopping-list-items');

        listContainer.innerHTML = currentRecipe.ingredients.map((ing, index) => `
            <div class="shopping-item" onclick="toggleItem(this)">
                <input type="checkbox" checked onclick="event.stopPropagation(); toggleItem(this.parentElement)">
                <span>${ing}</span>
            </div>
        `).join('');

        overlay.classList.add('open');
    }

    window.closeShoppingList = function() {
        document.getElementById('shopping-list-overlay').classList.remove('open');
    }

    window.toggleItem = function(el) {
        // Handle both the div click and checkbox click
        const item = el.classList.contains('shopping-item') ? el : el.closest('.shopping-item');
        const checkbox = item.querySelector('input[type="checkbox"]');

        // If clicked via div, toggle checkbox
        if (event.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
        }

        // Logic: Unchecked means "I don't need this" -> strikethrough
        if (!checkbox.checked) {
            item.classList.add('unchecked');
        } else {
            item.classList.remove('unchecked');
        }
    }

    // Event Listeners
    document.getElementById('recipe-grid').addEventListener('click', (e) => {
        const card = e.target.closest('.recipe-card');
        if (card) {
            openFullscreen(card.dataset.id);
        }
    });

    document.querySelector('.close-btn').addEventListener('click', closeFullscreen);
    document.getElementById('fs-card').addEventListener('click', toggleFlip);
    document.getElementById('shop-btn').addEventListener('click', openShoppingList);

    document.getElementById('shopping-list-overlay').addEventListener('click', (e) => {
        if (e.target.id === 'shopping-list-overlay') closeShoppingList();
    });

    // Make List / Share Logic
    document.getElementById('make-list-btn').addEventListener('click', async () => {
        // 1. Gather checked items
        const checkedItems = [];
        document.querySelectorAll('.shopping-item input[type="checkbox"]').forEach(cb => {
            if (cb.checked) {
                // Find the span text sibling
                const text = cb.parentElement.querySelector('span').textContent;
                checkedItems.push(text);
            }
        });

        if (checkedItems.length === 0) {
            alert("No items selected!");
            return;
        }

        const listText = `Shopping List for ${currentRecipe.title}:\n\n` + checkedItems.map(item => `- [ ] ${item}`).join('\n');

        // 2. Try Web Share API
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'Gousto Shopping List',
                    text: listText,
                });
            } catch (err) {
                // User cancelled or share failed
                console.log('Share failed:', err);
            }
        } else {
            // 3. Fallback to Clipboard
            try {
                await navigator.clipboard.writeText(listText);
                alert("List copied to clipboard! You can now paste it into your notes app.");
            } catch (err) {
                alert("Could not share or copy list.");
            }
        }
    });

    // View Toggle
    document.getElementById('view-toggle').addEventListener('click', toggleView);

    // Search Logic
    document.getElementById('search-icon').addEventListener('click', openSearch);

    document.getElementById('search-overlay').addEventListener('click', (e) => {
        if (e.target.id === 'search-overlay') closeSearch();
    });

    document.getElementById('search-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            closeSearch();
        } else if (e.key === 'Escape') {
            e.target.value = '';
            render(allRecipes); // Reset grid
            closeSearch();
        }
    });

    document.getElementById('search-input').addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase();
        const filtered = allRecipes.filter(r =>
            r.title.toLowerCase().includes(q) ||
            r.ingredients.some(i => i.toLowerCase().includes(q))
        );
        render(filtered);
    });

    // Global Keydown
    document.addEventListener('keydown', (e) => {
        if (e.key === "Escape") {
            // Close shopping list if open
            if (document.getElementById('shopping-list-overlay').classList.contains('open')) {
                closeShoppingList();
                return;
            }
            // Close fullscreen if open
            if (document.getElementById('fullscreen-viewer').classList.contains('open')) {
                closeFullscreen();
            }
            // Close search if open
            if (document.getElementById('search-overlay').classList.contains('open')) {
                document.getElementById('search-input').value = '';
                render(allRecipes);
                closeSearch();
            }
        }
    });

    init();

    // Register Service Worker for Offline Use
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
</script>
</body>
</html>